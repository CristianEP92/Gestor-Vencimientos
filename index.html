<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Vencimientos y Recordatorios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1400px; /* Adjusted for more columns */
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .table th, .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: middle;
        }
        .table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
        }
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-info { background-color: #0ea5e9; color: white; }
        .btn-info:hover { background-color: #0284c7; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .form-input, .form-textarea, .form-select, .form-checkbox, .form-time {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .form-checkbox { /* Specific styling for checkbox */
            width: auto; /* Override width for checkbox */
            padding: 0;
            margin-right: 0.5rem; /* Spacing for label */
            vertical-align: middle;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus, .form-time:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        label.flex { /* Ensure label for checkbox aligns well */
            display: flex;
            align-items: center;
        }
        .notification-area {
            margin-top: 1.5rem; padding: 1rem;
            background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 0.5rem;
        }
        .notification-item {
            padding: 0.75rem; margin-bottom: 0.5rem;
            background-color: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 0.375rem;
            color: #1e40af;
        }
        .modal {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease; padding: 1rem;
        }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            width: 90%; max-width: 600px; /* Slightly wider for more fields */
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .icon { height: 1.25rem; width: 1.25rem; margin-right: 0.25rem; }
        .icon-sm { height: 1rem; width: 1rem; margin-right: 0.25rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 text-center">Gestor de Vencimientos y Recordatorios</h1>
        </header>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Agregar Nueva Tarea</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                <div>
                    <label for="closingDate" class="block text-sm font-medium text-gray-700">Fecha de Cierre:</label>
                    <input type="date" id="closingDate" class="form-input">
                </div>
                <div>
                    <label for="daysForDueDate" class="block text-sm font-medium text-gray-700">Días para Vencimiento:</label>
                    <input type="number" id="daysForDueDate" value="45" min="0" class="form-input">
                </div>
                <div>
                    <label for="reminderDays" class="block text-sm font-medium text-gray-700">Recordatorio (días antes del vencimiento):</label>
                    <input type="number" id="reminderDays" value="7" min="0" class="form-input">
                </div>
                <div>
                    <label for="reminderTime" class="block text-sm font-medium text-gray-700">Hora Recordatorio (Calendario):</label>
                    <input type="time" id="reminderTime" value="09:00" class="form-time">
                </div>
                <div class="md:col-span-2"> {/* Spanning for layout */}
                    <label for="includeWeekends" class="flex items-center text-sm font-medium text-gray-700 mt-2 md:mt-8">
                        <input type="checkbox" id="includeWeekends" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        Incluir fines de semana en cálculo de vencimiento
                    </label>
                </div>
            </div>
             <div class="mt-4">
                <p class="text-sm text-gray-600">Fecha de Vencimiento Estimada: <strong id="estimatedDueDateDisplay" class="text-indigo-600">N/A</strong></p>
            </div>
            <div class="mt-6">
                <label for="reminderMessage" class="block text-sm font-medium text-gray-700">Mensaje del Recordatorio:</label>
                <textarea id="reminderMessage" rows="3" class="form-textarea" placeholder="Ej: Revisar el expediente X, contactar al cliente Y..."></textarea>
            </div>
            <div class="mt-6 text-right">
                <button id="addTaskBtn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Agregar Tarea
                </button>
            </div>
        </section>

        <section id="notificationArea" class="notification-area hidden mb-8">
            <h3 class="text-lg font-semibold text-indigo-700 mb-2">Recordatorios Activos:</h3>
            <div id="notificationList"></div>
        </section>
        
        <section class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Lista de Tareas</h2>
                <button id="exportCsvBtn" class="btn btn-success btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Exportar a CSV
                </button>
            </div>
            <table class="min-w-full table">
                <thead>
                    <tr>
                        <th>Fecha Cierre</th>
                        <th>Días p/ Venc.</th>
                        <th>Incluir FDS</th>
                        <th>Fecha Vencimiento</th>
                        <th>Días Record.</th>
                        <th>Fecha Record.</th>
                        <th>Hora Record.</th>
                        <th>Mensaje</th>
                        <th>Estado</th>
                        <th class="w-60">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tasksTableBody"></tbody>
            </table>
            <p id="noTasksMessage" class="text-center text-gray-500 py-4">No hay tareas registradas.</p>
        </section>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-lg font-semibold mb-2">Mensaje</h3>
            <p id="modalMessage" class="text-gray-700 mb-4"></p>
            <div class="text-right">
                <button id="modalCloseBtn" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="editTaskModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Editar Tarea</h3>
            <input type="hidden" id="editTaskId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <label for="editClosingDate" class="block text-sm font-medium text-gray-700">Fecha de Cierre:</label>
                    <input type="date" id="editClosingDate" class="form-input">
                </div>
                 <div>
                    <label for="editDaysForDueDate" class="block text-sm font-medium text-gray-700">Días para Vencimiento:</label>
                    <input type="number" id="editDaysForDueDate" min="0" class="form-input">
                </div>
                <div>
                    <label for="editReminderDays" class="block text-sm font-medium text-gray-700">Recordatorio (días antes del vencimiento):</label>
                    <input type="number" id="editReminderDays" min="0" class="form-input">
                </div>
                <div>
                    <label for="editReminderTime" class="block text-sm font-medium text-gray-700">Hora Recordatorio (Calendario):</label>
                    <input type="time" id="editReminderTime" class="form-time">
                </div>
                <div class="md:col-span-2">
                    <label for="editIncludeWeekends" class="flex items-center text-sm font-medium text-gray-700 mt-2">
                        <input type="checkbox" id="editIncludeWeekends" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        Incluir fines de semana en cálculo de vencimiento
                    </label>
                </div>
            </div>
            <div class="mt-2">
                 <p class="text-sm text-gray-600">Fecha de Vencimiento Estimada (Edición): <strong id="editEstimatedDueDateDisplay" class="text-indigo-600">N/A</strong></p>
            </div>
            <div class="mt-4">
                <label for="editReminderMessage" class="block text-sm font-medium text-gray-700">Mensaje del Recordatorio:</label>
                <textarea id="editReminderMessage" rows="3" class="form-textarea"></textarea>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelEditBtn" class="btn btn-secondary">Cancelar</button>
                <button id="saveChangesBtn" class="btn btn-primary">
                     <svg xmlns="http://www.w3.org/2000/svg" class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const closingDateInput = document.getElementById('closingDate');
        const daysForDueDateInput = document.getElementById('daysForDueDate');
        const includeWeekendsInput = document.getElementById('includeWeekends');
        const estimatedDueDateDisplay = document.getElementById('estimatedDueDateDisplay');
        const reminderDaysInput = document.getElementById('reminderDays');
        const reminderTimeInput = document.getElementById('reminderTime'); // New time input
        const reminderMessageInput = document.getElementById('reminderMessage');
        const addTaskBtn = document.getElementById('addTaskBtn');
        
        const tasksTableBody = document.getElementById('tasksTableBody');
        const noTasksMessage = document.getElementById('noTasksMessage');
        const notificationArea = document.getElementById('notificationArea');
        const notificationList = document.getElementById('notificationList');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        
        const editTaskModal = document.getElementById('editTaskModal');
        const editTaskIdInput = document.getElementById('editTaskId');
        const editClosingDateInput = document.getElementById('editClosingDate');
        const editDaysForDueDateInput = document.getElementById('editDaysForDueDate');
        const editIncludeWeekendsInput = document.getElementById('editIncludeWeekends');
        const editEstimatedDueDateDisplay = document.getElementById('editEstimatedDueDateDisplay');
        const editReminderDaysInput = document.getElementById('editReminderDays');
        const editReminderTimeInput = document.getElementById('editReminderTime'); // New time input for edit
        const editReminderMessageInput = document.getElementById('editReminderMessage');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');

        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let currentEditIndex = null;

        // --- Utility Functions ---
        function showModal(title, message, isError = false) {
            if (!messageModal || !modalTitle || !modalMessage) {
                console.error("Modal elements not found for showModal");
                alert(title + "\n" + message); 
                return;
            }
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = `text-lg font-semibold mb-2 ${isError ? 'text-red-600' : 'text-gray-800'}`;
            messageModal.classList.add('active');
        }

        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', () => {
                if (messageModal) messageModal.classList.remove('active');
            });
        }
        
        function calculateDueDate(closingDateStr, daysToAdd, includeWeekends) {
            if (!closingDateStr || typeof daysToAdd !== 'number' || daysToAdd < 0) return null;
            
            const parts = closingDateStr.split('-');
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1; 
            const day = parseInt(parts[2]);

            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;

            const closingDate = new Date(Date.UTC(year, month, day));
            if (isNaN(closingDate.getTime())) return null;

            if (daysToAdd === 0) {
                return new Date(closingDate.getTime());
            }

            let currentDate = new Date(closingDate.getTime());

            if (includeWeekends) {
                currentDate.setUTCDate(currentDate.getUTCDate() + daysToAdd);
            } else {
                let businessDaysAdded = 0;
                while (businessDaysAdded < daysToAdd) {
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                    const dayOfWeek = currentDate.getUTCDay(); 
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        businessDaysAdded++;
                    }
                }
            }
            return currentDate;
        }

        function formatDate(date) {
            if (!date || !(date instanceof Date) || isNaN(date.getTime())) return 'N/A';
            return date.toISOString().split('T')[0];
        }
        
        function formatDisplayDate(dateStr) {
            if (!dateStr || dateStr === 'N/A') return 'N/A';
            const date = new Date(dateStr + "T00:00:00Z"); 
            if (isNaN(date.getTime())) return 'N/A';
            const day = String(date.getUTCDate()).padStart(2, '0'); 
            const month = String(date.getUTCMonth() + 1).padStart(2, '0'); 
            const year = date.getUTCFullYear(); 
            return `${day}/${month}/${year}`;
        }

        function formatICSDateTime(dateStr, timeStr) {
            if (!dateStr || dateStr === 'N/A' || !timeStr) return '';
            const datePart = dateStr.replace(/-/g, '');
            const timePart = timeStr.replace(/:/g, '') + '00'; // Add seconds
            return `${datePart}T${timePart}Z`; // Format as YYYYMMDDTHHMMSSZ for UTC
        }
         function formatICSEndDateTime(dateStr, timeStr, durationHours = 1) {
            if (!dateStr || dateStr === 'N/A' || !timeStr) return '';
            
            const [hours, minutes] = timeStr.split(':').map(Number);
            const startDate = new Date(`${dateStr}T${timeStr}:00Z`); // Ensure it's parsed as UTC

            if (isNaN(startDate.getTime())) return '';

            startDate.setUTCHours(startDate.getUTCHours() + durationHours);
            
            const year = startDate.getUTCFullYear();
            const month = String(startDate.getUTCMonth() + 1).padStart(2, '0');
            const day = String(startDate.getUTCDate()).padStart(2, '0');
            const endHours = String(startDate.getUTCHours()).padStart(2, '0');
            const endMinutes = String(startDate.getUTCMinutes()).padStart(2, '0');
            
            return `${year}${month}${day}T${endHours}${endMinutes}00Z`;
        }


        function updateEstimatedDueDateLive(cDateInput, dForDueDateInput, iWeekendsInput, displayElement) {
            if (!cDateInput || !dForDueDateInput || !iWeekendsInput || !displayElement) return;

            const closingDate = cDateInput.value;
            const daysStr = dForDueDateInput.value;
            const includeWeekends = iWeekendsInput.checked;

            if (closingDate && daysStr.trim() !== "") {
                const days = parseInt(daysStr);
                if (!isNaN(days) && days >= 0) {
                    const estimatedDueDate = calculateDueDate(closingDate, days, includeWeekends);
                    displayElement.textContent = formatDisplayDate(formatDate(estimatedDueDate));
                    return;
                }
            }
            displayElement.textContent = 'N/A';
        }

        // --- Application Logic ---
        function renderTasks() {
            if (!tasksTableBody || !noTasksMessage) return;
            tasksTableBody.innerHTML = ''; 
            if (tasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
                if(tasksTableBody.parentElement) tasksTableBody.parentElement.classList.add('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                if(tasksTableBody.parentElement) tasksTableBody.parentElement.classList.remove('hidden');
                tasks.forEach((task, index) => {
                    const row = tasksTableBody.insertRow();
                    row.innerHTML = `
                        <td class="whitespace-nowrap">${formatDisplayDate(task.closingDate)}</td>
                        <td class="text-center">${task.daysForDueDate}</td>
                        <td class="text-center">${task.includeWeekends ? 'Sí' : 'No'}</td>
                        <td class="whitespace-nowrap">${formatDisplayDate(task.dueDate)}</td>
                        <td class="text-center">${task.reminderDays}</td>
                        <td class="whitespace-nowrap">${formatDisplayDate(task.reminderDate)}</td>
                        <td class="text-center">${task.reminderTime || 'N/A'}</td>
                        <td class="max-w-xs break-words" title="${task.reminderMessage}">${task.reminderMessage.substring(0,20)}${task.reminderMessage.length > 20 ? '...' : ''}</td>
                        <td>${getReminderStatus(task)}</td>
                        <td class="space-x-1 whitespace-nowrap">
                            <button class="btn btn-info btn-sm" onclick="downloadICS(${index})"><svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Calendario</button>
                            <button class="btn btn-secondary btn-sm" onclick="openEditModal(${index})"><svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>Editar</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask(${index})"><svg xmlns="http://www.w3.org/2000/svg" class="icon-sm" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Borrar</button>
                        </td>
                    `;
                });
            }
            checkAndDisplayReminders(); 
            if (exportCsvBtn) exportCsvBtn.disabled = tasks.length === 0;
        }
        
        function getReminderStatus(task) {
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0); 
            
            if (!task.reminderDate || task.reminderDate === 'N/A') {
                 return `<span class="px-2 py-1 text-xs font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full">Inválido</span>`;
            }
            // For status check, we only care about the date part of the reminder.
            const reminderDateOnly = new Date(task.reminderDate + "T00:00:00Z"); 

            if (isNaN(reminderDateOnly.getTime())) {
                return `<span class="px-2 py-1 text-xs font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full">Fecha Inv.</span>`;
            }

            if (task.reminderTriggered) {
                return `<span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full">Notificado</span>`;
            } else if (reminderDateOnly <= today) {
                return `<span class="px-2 py-1 text-xs font-semibold leading-tight text-yellow-700 bg-yellow-100 rounded-full">Pendiente Hoy</span>`;
            } else {
                return `<span class="px-2 py-1 text-xs font-semibold leading-tight text-blue-700 bg-blue-100 rounded-full">Programado</span>`;
            }
        }

        function addTask() {
            if (!closingDateInput || !daysForDueDateInput || !includeWeekendsInput || !reminderDaysInput || !reminderTimeInput || !reminderMessageInput) {
                showModal('Error Interno', 'No se pudieron encontrar algunos campos del formulario.', true);
                return;
            }

            const closingDateStr = closingDateInput.value;
            const daysForDueDateStr = daysForDueDateInput.value;
            const includeWeekends = includeWeekendsInput.checked;
            const reminderDaysStr = reminderDaysInput.value;
            const reminderTime = reminderTimeInput.value; // Get time value
            const reminderMessage = reminderMessageInput.value.trim();

            if (!closingDateStr) {
                showModal('Error de Validación', 'Por favor, ingrese una fecha de cierre.', true); return;
            }
            const closingDateTest = new Date(closingDateStr + "T00:00:00Z");
            if (isNaN(closingDateTest.getTime())) {
                 showModal('Error de Validación', 'La fecha de cierre no es válida.', true); return;
            }
            
            if (daysForDueDateStr.trim() === "" || isNaN(parseInt(daysForDueDateStr)) || parseInt(daysForDueDateStr) < 0) {
                 showModal('Error de Validación', 'Por favor, ingrese un número válido de días para vencimiento (mayor o igual a 0).', true); return;
            }
            const daysForDueDate = parseInt(daysForDueDateStr);
            
            if (reminderDaysStr.trim() === "" || isNaN(parseInt(reminderDaysStr)) || parseInt(reminderDaysStr) < 0) {
                showModal('Error de Validación', 'Por favor, ingrese un número válido de días para el recordatorio (mayor o igual a 0).', true); return;
            }
            const reminderDays = parseInt(reminderDaysStr);

            if (!reminderTime) { // Basic check for time
                showModal('Error de Validación', 'Por favor, ingrese una hora para el recordatorio.', true); return;
            }

            if (!reminderMessage) {
                showModal('Error de Validación', 'Por favor, ingrese un mensaje para el recordatorio.', true); return;
            }

            const dueDateObj = calculateDueDate(closingDateStr, daysForDueDate, includeWeekends);
            if (!dueDateObj) {
                showModal('Error de Cálculo', 'No se pudo calcular la fecha de vencimiento. Verifique los datos.', true); return;
            }
            
            const reminderDateObj = new Date(dueDateObj.getTime());
            reminderDateObj.setUTCDate(dueDateObj.getUTCDate() - reminderDays);

            const newTask = {
                id: Date.now(), 
                closingDate: closingDateStr, 
                daysForDueDate: daysForDueDate,
                includeWeekends: includeWeekends,
                dueDate: formatDate(dueDateObj),
                reminderDays: reminderDays,
                reminderTime: reminderTime, // Store time
                reminderMessage: reminderMessage,
                reminderDate: formatDate(reminderDateObj),
                reminderTriggered: false 
            };

            tasks.push(newTask);
            saveTasks();
            renderTasks();

            closingDateInput.value = formatDate(new Date()); 
            daysForDueDateInput.value = "45";
            includeWeekendsInput.checked = false;
            reminderDaysInput.value = "7";
            reminderTimeInput.value = "09:00"; // Reset time
            reminderMessageInput.value = '';
            updateEstimatedDueDateLive(closingDateInput, daysForDueDateInput, includeWeekendsInput, estimatedDueDateDisplay);
            showModal('Tarea Agregada', 'La nueva tarea ha sido agregada exitosamente.');
        }

        window.openEditModal = function(index) {
            if (!editTaskModal || !editClosingDateInput || !editDaysForDueDateInput || !editIncludeWeekendsInput || !editReminderDaysInput || !editReminderTimeInput || !editReminderMessageInput || !editEstimatedDueDateDisplay) {
                 showModal('Error Interno', 'No se pudieron encontrar los campos del formulario de edición.', true);
                return;
            }
            currentEditIndex = index;
            const task = tasks[index];
            if (!task) {
                showModal('Error Interno', 'No se encontró la tarea para editar.', true);
                return;
            }
            
            editTaskIdInput.value = task.id;
            editClosingDateInput.value = task.closingDate; 
            editDaysForDueDateInput.value = task.daysForDueDate;
            editIncludeWeekendsInput.checked = task.includeWeekends;
            editReminderDaysInput.value = task.reminderDays;
            editReminderTimeInput.value = task.reminderTime || "09:00"; // Set time, default if not present
            editReminderMessageInput.value = task.reminderMessage;
            
            updateEstimatedDueDateLive(editClosingDateInput, editDaysForDueDateInput, editIncludeWeekendsInput, editEstimatedDueDateDisplay);
            editTaskModal.classList.add('active');
        }

        function saveEditedTask() {
            if (currentEditIndex === null || !tasks[currentEditIndex] || !editClosingDateInput || !editDaysForDueDateInput || !editIncludeWeekendsInput || !editReminderDaysInput || !editReminderTimeInput || !editReminderMessageInput) {
                showModal('Error Interno', 'No se pudo guardar la tarea. Faltan datos o referencias.', true);
                return;
            }

            const closingDateStr = editClosingDateInput.value;
            const daysForDueDateStr = editDaysForDueDateInput.value;
            const includeWeekends = editIncludeWeekendsInput.checked;
            const reminderDaysStr = editReminderDaysInput.value;
            const reminderTime = editReminderTimeInput.value; // Get edited time
            const reminderMessage = editReminderMessageInput.value.trim();

            if (!closingDateStr) {
                showModal('Error de Validación (Edición)', 'La fecha de cierre no puede estar vacía.', true); return;
            }
            const closingDateTest = new Date(closingDateStr + "T00:00:00Z");
             if (isNaN(closingDateTest.getTime())) {
                 showModal('Error de Validación (Edición)', 'La fecha de cierre no es válida.', true); return;
            }
            if (daysForDueDateStr.trim() === "" || isNaN(parseInt(daysForDueDateStr)) || parseInt(daysForDueDateStr) < 0) {
                showModal('Error de Validación (Edición)', 'Días para vencimiento inválido (debe ser mayor o igual a 0).', true); return;
            }
            const daysForDueDate = parseInt(daysForDueDateStr);

            if (reminderDaysStr.trim() === "" || isNaN(parseInt(reminderDaysStr)) || parseInt(reminderDaysStr) < 0) {
                showModal('Error de Validación (Edición)', 'Número de días para recordatorio inválido (debe ser mayor o igual a 0).', true); return;
            }
            const reminderDays = parseInt(reminderDaysStr);

            if (!reminderTime) {
                showModal('Error de Validación (Edición)', 'Por favor, ingrese una hora para el recordatorio.', true); return;
            }
            
            if (!reminderMessage) {
                showModal('Error de Validación (Edición)', 'El mensaje del recordatorio no puede estar vacío.', true); return;
            }

            const dueDateObj = calculateDueDate(closingDateStr, daysForDueDate, includeWeekends);
            if (!dueDateObj) {
                showModal('Error de Cálculo (Edición)', 'No se pudo calcular la fecha de vencimiento.', true); return;
            }
            const reminderDateObj = new Date(dueDateObj.getTime());
            reminderDateObj.setUTCDate(dueDateObj.getUTCDate() - reminderDays);

            const updatedTask = {
                ...tasks[currentEditIndex], 
                closingDate: closingDateStr, 
                daysForDueDate: daysForDueDate,
                includeWeekends: includeWeekends,
                dueDate: formatDate(dueDateObj),
                reminderDays: reminderDays,
                reminderTime: reminderTime, // Save edited time
                reminderMessage: reminderMessage,
                reminderDate: formatDate(reminderDateObj),
                reminderTriggered: (formatDate(reminderDateObj) === tasks[currentEditIndex].reminderDate && formatDate(dueDateObj) === tasks[currentEditIndex].dueDate && reminderTime === tasks[currentEditIndex].reminderTime) ? tasks[currentEditIndex].reminderTriggered : false
            };
            
            tasks[currentEditIndex] = updatedTask;
            saveTasks();
            renderTasks();
            if (editTaskModal) editTaskModal.classList.remove('active');
            currentEditIndex = null;
            showModal('Tarea Actualizada', 'Los cambios en la tarea han sido guardados.');
        }

        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', () => {
                if (editTaskModal) editTaskModal.classList.remove('active');
                currentEditIndex = null;
            });
        }

        window.deleteTask = function(index) { 
            const taskToDelete = tasks[index];
            if (!taskToDelete) {
                showModal('Error Interno', 'No se encontró la tarea para eliminar.', true);
                return;
            }
            modalTitle.textContent = 'Confirmar Eliminación';
            modalMessage.textContent = `¿Está seguro de que desea eliminar esta tarea?\nFecha de Cierre: ${formatDisplayDate(taskToDelete.closingDate)}\nMensaje: ${taskToDelete.reminderMessage.substring(0,30)}...`;
            modalTitle.className = 'text-lg font-semibold mb-2 text-red-600';
            
            modalCloseBtn.textContent = 'Cancelar';
            const originalCloseHandler = () => {
                messageModal.classList.remove('active');
                modalCloseBtn.textContent = 'Cerrar';
                modalCloseBtn.onclick = () => messageModal.classList.remove('active');
                const confirmBtn = document.getElementById('modalConfirmDeleteBtn');
                if (confirmBtn) confirmBtn.remove();
            };
            modalCloseBtn.onclick = originalCloseHandler;

            let confirmBtn = document.getElementById('modalConfirmDeleteBtn');
            if (!confirmBtn) {
                confirmBtn = document.createElement('button');
                confirmBtn.id = 'modalConfirmDeleteBtn';
                confirmBtn.className = 'btn btn-danger ml-3';
                if (modalCloseBtn.parentElement) modalCloseBtn.parentElement.appendChild(confirmBtn);
            }
            confirmBtn.textContent = 'Eliminar';
            confirmBtn.onclick = () => {
                tasks.splice(index, 1);
                saveTasks();
                renderTasks();
                messageModal.classList.remove('active');
                showModal('Tarea Eliminada', 'La tarea ha sido eliminada.');
                originalCloseHandler(); 
            };
            messageModal.classList.add('active');
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }
        
        function checkAndDisplayReminders() {
            if (!notificationList || !notificationArea) return;
            notificationList.innerHTML = ''; 
            let activeRemindersExist = false;
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0); 

            tasks.forEach(task => {
                if (!task.reminderDate || task.reminderDate === 'N/A') return;
                const reminderDateOnly = new Date(task.reminderDate + "T00:00:00Z"); 

                if (!isNaN(reminderDateOnly.getTime()) && reminderDateOnly <= today && !task.reminderTriggered) {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'notification-item flex justify-between items-center';
                    notificationItem.innerHTML = `
                        <div>
                            <p class="font-semibold">¡Recordatorio!</p>
                            <p><strong>Vence:</strong> ${formatDisplayDate(task.dueDate)} - <strong>Mensaje:</strong> ${task.reminderMessage}</p>
                        </div>
                        <button class="text-xs text-blue-600 hover:underline ml-2 p-1 bg-blue-200 rounded" onclick="markReminderAsNotified(${task.id})">Marcar Notificado</button>
                    `;
                    notificationList.appendChild(notificationItem);
                    activeRemindersExist = true;
                }
            });
            notificationArea.classList.toggle('hidden', !activeRemindersExist);
        }
        
        window.markReminderAsNotified = function(taskId) { 
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].reminderTriggered = true;
                saveTasks();
                renderTasks(); 
                showModal('Recordatorio Actualizado', 'El recordatorio ha sido marcado como notificado.');
            }
        }

        function exportToCSV() {
            if (tasks.length === 0) {
                showModal('Exportar CSV', 'No hay tareas para exportar.', true); return;
            }
            const headers = ["Fecha de Cierre", "Dias para Vencimiento", "Incluye Fines de Semana", "Fecha de Vencimiento", "Dias para Recordatorio", "Fecha Recordatorio", "Hora Recordatorio", "Mensaje del Recordatorio", "Recordatorio Notificado"];
            const csvRows = [headers.join(',')]; 
            tasks.forEach(task => {
                const row = [
                    formatDisplayDate(task.closingDate), 
                    task.daysForDueDate,
                    task.includeWeekends ? "Sí" : "No",
                    formatDisplayDate(task.dueDate),
                    task.reminderDays,
                    formatDisplayDate(task.reminderDate),
                    task.reminderTime || "N/A", // Add reminder time to CSV
                    `"${task.reminderMessage.replace(/"/g, '""')}"`, 
                    task.reminderTriggered ? "Sí" : "No"
                ];
                csvRows.push(row.join(','));
            });
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'tareas_vencimientos.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                showModal('Exportar CSV', 'La descarga directa de CSV no es compatible con tu navegador.', true);
            }
        }

        function generateICSContent(task) {
            const reminderDateTime = formatICSDateTime(task.reminderDate, task.reminderTime);
            const reminderEndDateTime = formatICSEndDateTime(task.reminderDate, task.reminderTime, 1); // 1 hour duration

            if (!reminderDateTime || !reminderEndDateTime) return null; 
            
            const now = new Date().toISOString().replace(/-|:|\.\d{3}/g, '');
            const uid = `${task.id}@gestorvencimientos.app`; 
            const summary = task.reminderMessage.replace(/\r\n|\r|\n/g, ' ');
            const description = `Recordatorio para tarea con vencimiento el ${formatDisplayDate(task.dueDate)}.\\nMensaje: ${summary}`;

            return [
                'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//TuNombre//GestorDeVencimientosApp//ES',
                'BEGIN:VEVENT', 
                `UID:${uid}`, 
                `DTSTAMP:${now}`, 
                `DTSTART:${reminderDateTime}`, // Event with specific start time (UTC)
                `DTEND:${reminderEndDateTime}`,   // Event with specific end time (UTC)
                `SUMMARY:${summary}`, 
                `DESCRIPTION:${description.replace(/\n/g, '\\n')}`,
                'BEGIN:VALARM', 
                'TRIGGER:-PT0M', // Trigger at the exact start time of the event
                'ACTION:DISPLAY', 
                'DESCRIPTION:Recordatorio', 
                'END:VALARM',
                'END:VEVENT', 
                'END:VCALENDAR'
            ].join('\r\n');
        }

        window.downloadICS = function(taskIndex) {
            const task = tasks[taskIndex];
            if (!task || !task.reminderDate || task.reminderDate === 'N/A' || !task.reminderTime) {
                showModal('Error Calendario', 'No se puede generar un evento de calendario sin una fecha y hora de recordatorio válidas.', true);
                return;
            }
            const icsString = generateICSContent(task);
            if (!icsString) {
                 showModal('Error Calendario', 'No se pudo generar el contenido del evento de calendario (fecha u hora de recordatorio inválida).', true);
                return;
            }
            const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8;' });
            const link = document.createElement('a');
            const fileNameSafeMessage = task.reminderMessage.substring(0, 20).replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const fileName = `Recordatorio_${fileNameSafeMessage}_${task.reminderDate}_${task.reminderTime.replace(':','')}.ics`;

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url); link.setAttribute('download', fileName);
                link.style.visibility = 'hidden'; document.body.appendChild(link);
                link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                showModal('Calendario', `Archivo .ics "${fileName}" generado. Impórtalo en tu aplicación de calendario.`);
            } else {
                showModal('Error Calendario', 'La descarga directa de archivos .ics no es compatible con tu navegador.', true);
            }
        }

        // --- Event Listeners for Live Due Date Update & Initialization ---
        if (closingDateInput && daysForDueDateInput && includeWeekendsInput && estimatedDueDateDisplay) {
            [closingDateInput, daysForDueDateInput, includeWeekendsInput].forEach(input => {
                input.addEventListener('input', () => {
                    updateEstimatedDueDateLive(closingDateInput, daysForDueDateInput, includeWeekendsInput, estimatedDueDateDisplay);
                });
            });
            closingDateInput.value = formatDate(new Date()); 
            if (reminderTimeInput) reminderTimeInput.value = "09:00"; // Set default time for new tasks
            updateEstimatedDueDateLive(closingDateInput, daysForDueDateInput, includeWeekendsInput, estimatedDueDateDisplay);
        }

        if (editClosingDateInput && editDaysForDueDateInput && editIncludeWeekendsInput && editEstimatedDueDateDisplay) {
            [editClosingDateInput, editDaysForDueDateInput, editIncludeWeekendsInput].forEach(input => {
                input.addEventListener('input', () => {
                    updateEstimatedDueDateLive(editClosingDateInput, editDaysForDueDateInput, editIncludeWeekendsInput, editEstimatedDueDateDisplay);
                });
            });
        }
        
        if (addTaskBtn) addTaskBtn.addEventListener('click', addTask);
        if (saveChangesBtn) saveChangesBtn.addEventListener('click', saveEditedTask);
        if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportToCSV);
        
        renderTasks(); 
    });
    </script>
</body>
</html>
